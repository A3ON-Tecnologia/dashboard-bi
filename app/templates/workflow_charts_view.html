<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ workflow.nome }} Â· VisualizaÃ§Ã£o</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <style>
        body { font-family: 'Space Mono', monospace; }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollbar-thin::-webkit-scrollbar-thumb { border-radius: 9999px; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
</head>
<body class="{{ theme.bg }} {{ theme.text }} min-h-screen">
    <main class="min-h-screen overflow-y-auto scrollbar-thin">
        <div class="w-full px-3 md:px-4 lg:px-6 py-4 space-y-6">
            <header class="flex flex-col gap-2">
                <p class="text-sm uppercase tracking-wide opacity-60">{{ workflow.tipo.replace('_', ' ') }}</p>
                <h1 class="text-3xl font-semibold">{{ workflow.nome }}</h1>
                {% if empresa %}
                <p class="text-sm opacity-70">Empresa: <span class="font-semibold">{{ empresa.nome }}</span></p>
                {% endif %}
            </header>

            <section class="rounded-2xl border border-white/10 bg-white/5 backdrop-blur px-4 md:px-5 py-4 md:py-5 space-y-4">
                <div class="flex items-center justify-between gap-3">
                    <h2 class="text-xl font-semibold">Dados disponÃ­veis</h2>
                    <button id="refreshCharts" class="px-3 py-2 rounded-lg border border-white/15 hover:border-white/40 transition text-xs">Atualizar</button>
                </div>
                <div id="datasetSummary" class="grid gap-2 text-sm opacity-80">
                    <p>Carregando informaÃ§Ãµes...</p>
                </div>
            </section>

            <section id="chartGrid" class="space-y-6">
                <div class="text-sm opacity-70">Carregando grÃ¡ficos cadastrados...</div>
            </section>
        </div>
    </main>

    <!-- Botão flutuante (topo direito) para configurar layout -->
    <button id="openLayoutModal" title="Configurar layout" aria-label="Configurar layout"
            class="fixed top-4 right-4 z-50 p-2 rounded-lg border border-white/15 hover:border-white/40 bg-white/5 backdrop-blur">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="opacity-90">
            <rect x="3" y="3" width="7" height="7" rx="1"/>
            <rect x="14" y="3" width="7" height="7" rx="1"/>
            <rect x="3" y="14" width="7" height="7" rx="1"/>
            <rect x="14" y="14" width="7" height="7" rx="1"/>
        </svg>
    </button>

    <!-- Modal de Layout -->
    <div id="layoutModal" class="fixed inset-0 bg-black/60 hidden z-50">
        <div class="w-full h-full flex items-center justify-center p-6">
            <div class="max-w-2xl w-full {{ theme.modal }} rounded-2xl border border-white/10 shadow-2xl overflow-hidden">
                <header class="px-6 py-4 border-b border-white/10 flex items-center justify-between">
                    <h2 class="text-lg font-semibold">Layout de visualização</h2>
                    <button class="p-2 rounded-lg hover:bg-white/10" data-layout-close>✕</button>
                </header>
                <div class="px-4 md:px-5 py-4 md:py-5 space-y-5 max-h-[70vh] overflow-y-auto scrollbar-thin">
                    <div class="grid gap-2">
                        <label class="text-sm opacity-80">Colunas</label>
                        <select id="layoutCols" class="rounded-lg border border-white/20 bg-transparent px-3 py-2">
                            <option value="1">1 coluna</option>
                            <option value="2">2 colunas</option>
                            <option value="3">3 colunas</option>
                        </select>
                    </div>
                    <div class="grid gap-2">
                        <label class="text-sm opacity-80">Ordem e seleção de gráficos</label>
                        <p class="text-xs opacity-60">Marque para exibir e use ↑/↓ para ordenar.</p>
                        <ul id="layoutChartList" class="divide-y divide-white/10 rounded-lg border border-white/10"></ul>
                    </div>
                </div>
                <footer class="px-6 py-4 border-t border-white/10 flex items-center justify-end gap-3">
                    <button class="px-4 py-2 rounded-lg border border-white/20 hover:border-white/40" data-layout-cancel>Cancelar</button>
                    <button class="px-4 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 text-white font-medium" data-layout-save>Salvar</button>
                </footer>
            </div>
        </div>
    </div>

    <div id="toastContainer" class="fixed top-4 right-4 z-50 flex flex-col gap-3 pointer-events-none"></div>

    <script>
        window.__WORKFLOW__ = {{ workflow|tojson }};
        window.__EMPRESA__ = {{ (empresa or {})|tojson }};
        window.__READ_ONLY__ = true;
        window.__THEME__ = {{ theme|tojson }};
        window.__THEME_OPTIONS__ = {{ theme_options|tojson }};
        (function(){
            try{
                var wf = window.__WORKFLOW__ || {};
                var emp = window.__EMPRESA__ || {};
                if(!wf || !wf.id || !emp || !emp.nome) return;
                var slug = (emp.nome||'').toString()
                    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
                    .toLowerCase().replace(/[^a-z0-9]+/g,'-')
                    .replace(/(^-|-$)/g,'') || 'empresa';
                var current = window.location.pathname;
                var desired = '/empresas/' + slug + '/' + wf.id + '/dashboards/visualizar';
                if(/^\/workflows\/\d+\/dashboards\/visualizar\/?$/.test(current) && current !== desired){
                    window.history.replaceState({}, document.title, desired + window.location.search + window.location.hash);
                }
            }catch(e){ console.warn('Nao foi possivel ajustar URL amigavel dos dashboards visualizar:', e); }
        })();
    </script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script src="{{ url_for('static', filename='js/workflow_charts.js') }}"></script>
    <script>
        // Ocultar/neutralizar aÃ§Ãµes de ediÃ§Ã£o/exclusÃ£o caso renderizadas pelo JS de grÃ¡ficos
        document.addEventListener('DOMContentLoaded', function(){
            var btn = document.getElementById('openChartModal');
            if (btn) btn.remove();
        });
        window.editChart = function(){ return false; };
        window.deleteChart = function(){ return false; };
        
        // ====== Layout (somente nesta view de visualização) ======
        (function(){
            const wf = window.__WORKFLOW__ || {};
            const key = `wf_layout_${wf.id}`;
            const chartGrid = document.getElementById('chartGrid');

            function readLayout(){ try { return JSON.parse(localStorage.getItem(key) || 'null'); } catch { return null; } }
            function applyLayout(){
                const cfg = readLayout();
                if (!cfg || !chartGrid) return;
                chartGrid.classList.remove('space-y-6');
                chartGrid.classList.add('grid','gap-6','grid-cols-1');
                chartGrid.classList.remove('md:grid-cols-2','md:grid-cols-3');
                if (cfg.cols === 2) chartGrid.classList.add('md:grid-cols-2');
                if (cfg.cols === 3) chartGrid.classList.add('md:grid-cols-3');
                if (Array.isArray(cfg.order) && cfg.order.length) {
                    const map = new Map(Array.from(chartGrid.querySelectorAll('[data-chart-id]')).map(el => [String(el.getAttribute('data-chart-id')), el]));
                    const frag = document.createDocumentFragment();
                    cfg.order.forEach(id => { const el = map.get(String(id)); if (el) frag.appendChild(el); });
                    chartGrid.appendChild(frag);
                }
            }

            // Reaplicar quando os gráficos forem renderizados
            const mo = new MutationObserver((muts) => {
                if (Array.from(muts).some(m => m.addedNodes && m.addedNodes.length)) {
                    applyLayout();
                }
            });
            if (chartGrid) mo.observe(chartGrid, { childList: true });

            // Modal
            const openBtn = document.getElementById('openLayoutModal');
            const modal = document.getElementById('layoutModal');
            const colsSel = document.getElementById('layoutCols');
            const listEl = document.getElementById('layoutChartList');
            const closeEls = modal.querySelectorAll('[data-layout-close],[data-layout-cancel]');
            function open(){ modal.classList.remove('hidden'); populate(); }
            function close(){ modal.classList.add('hidden'); }
            closeEls.forEach(el => el.addEventListener('click', close));
            if (openBtn) openBtn.addEventListener('click', open);

            async function fetchCharts(){
                const { apiRequest } = window.dashboardUtils || {};
                if (!apiRequest || !wf.id) return [];
                try { const res = await apiRequest(`/api/workflows/${wf.id}/dashboards`, 'GET'); return Array.isArray(res?.charts) ? res.charts : []; } catch { return []; }
            }

            function makeRow(item){
                const id = item.id;
                const name = item?.config?.nome || item?.chart?.nome || item?.nome || `Gráfico ${id}`;
                const li = document.createElement('li');
                li.className = 'flex items-center gap-3 px-3 py-2';
                li.setAttribute('data-id', String(id));
                li.innerHTML = `
                    <input type="checkbox" class="shrink-0" checked />
                    <span class="flex-1 text-sm truncate">${name}</span>
                    <div class="flex gap-2">
                        <button type="button" class="px-2 py-1 rounded border border-white/15 text-xs" data-move="up">↑</button>
                        <button type="button" class="px-2 py-1 rounded border border-white/15 text-xs" data-move="down">↓</button>
                    </div>`;
                return li;
            }

            function reorder(li, dir){
                if (!li || !li.parentElement) return;
                if (dir === 'up' && li.previousElementSibling) li.parentElement.insertBefore(li, li.previousElementSibling);
                if (dir === 'down' && li.nextElementSibling) li.parentElement.insertBefore(li.nextElementSibling, li);
            }

            async function populate(){
                listEl.innerHTML = '<li class="px-3 py-2 text-sm opacity-60">Carregando...</li>';
                const items = await fetchCharts();
                const cfg = readLayout();
                colsSel.value = String((cfg && cfg.cols) || 1);
                const byId = new Map(items.map(it => [String(it.id), it]));
                let ordered = items.slice();
                if (cfg && Array.isArray(cfg.order) && cfg.order.length) {
                    ordered = cfg.order.map(id => byId.get(String(id))).filter(Boolean);
                    items.forEach(it => { if (!cfg.order.includes(it.id)) ordered.push(it); });
                }
                listEl.innerHTML = '';
                ordered.forEach(it => listEl.appendChild(makeRow(it)));
                if (cfg && Array.isArray(cfg.order)) {
                    Array.from(listEl.children).forEach(li => {
                        const id = Number(li.getAttribute('data-id'));
                        const cb = li.querySelector('input[type="checkbox"]');
                        if (cb) cb.checked = cfg.order.includes(id);
                    });
                }
            }

            listEl.addEventListener('click', (e) => {
                const btn = e.target.closest('button[data-move]');
                if (!btn) return;
                const li = btn.closest('li');
                reorder(li, btn.getAttribute('data-move'));
            });

            modal.querySelector('[data-layout-save]').addEventListener('click', () => {
                const cols = parseInt(colsSel.value, 10) || 1;
                const order = [];
                Array.from(listEl.children).forEach(li => {
                    const cb = li.querySelector('input[type="checkbox"]');
                    if (cb && cb.checked) order.push(Number(li.getAttribute('data-id')));
                });
                const cfg = { cols, order };
                try { localStorage.setItem(key, JSON.stringify(cfg)); } catch {}
                close();
                applyLayout();
            });

            document.addEventListener('DOMContentLoaded', applyLayout);
        })();
    </script>
</body>
</html>


