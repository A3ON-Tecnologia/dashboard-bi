{% extends "layout.html" %}

{% block title %}Empresa · {{ empresa.nome }}{% endblock %}

{% block content %}
<section class="space-y-8">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
    <div>
      <p class="text-sm uppercase tracking-wide opacity-60">Empresa</p>
      <h1 class="text-3xl font-semibold mt-1">{{ empresa.nome }}</h1>
      <p class="text-sm opacity-70">{{ empresa.descricao or 'Sem descrição informada.' }}</p>
    </div>
    <div class="flex gap-2">
      <button type="button" id="openEditEmpresa" class="px-4 py-2 rounded-lg border border-blue-400/40 text-blue-200 hover:border-blue-400 hover:text-blue-100 transition text-sm">Editar empresa</button>
      <button type="button" id="openDeleteEmpresa" class="px-4 py-2 rounded-lg border border-red-400/40 text-red-200 hover:border-red-400 hover:text-red-100 transition text-sm">Excluir empresa</button>
      <a href="{{ url_for('web.index') }}" class="inline-flex items-center justify-center gap-2 rounded-lg px-5 py-2.5 font-medium {{ theme.buttons.primary }} transition text-sm">Voltar ao início</a>
    </div>
  </div>

  <div class="rounded-2xl border border-white/10 bg-white/5 backdrop-blur px-6 py-6">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
      <div>
        <h2 class="text-xl font-semibold">Workflows da empresa</h2>
        <p class="text-sm opacity-70">{{ workflows|length }} workflow(s) encontrados.</p>
      </div>
      <button id="openCreateWorkflowEmpresa" class="inline-flex items-center justify-center gap-2 rounded-lg px-5 py-2.5 font-medium {{ theme.buttons.primary }} transition">
        <span>+ Criar workflow</span>
      </button>
    </div>

    <div id="empresaWorkflowList" class="grid md:grid-cols-2 gap-4">
      {% for item in workflows %}
      <article class="rounded-xl border border-white/10 bg-black/10 backdrop-blur px-5 py-4 flex flex-col gap-4">
        <div>
          <p class="text-sm uppercase tracking-wide opacity-60">{{ item.tipo.replace('_', ' ') }}</p>
          <h3 class="text-lg font-semibold">{{ item.nome }}</h3>
          <p class="text-sm opacity-70">{{ item.descricao or 'Sem descrição informada.' }}</p>
        </div>
        <div class="flex flex-wrap gap-3">
          <a href="{{ url_for('web.workflow_detail_view', workflow_id=item.id) }}" class="inline-flex items-center justify-center px-4 py-2 rounded-lg border !border-emerald-400/40 !text-emerald-200 hover:!border-emerald-400 hover:!text-emerald-100 transition text-sm">Abrir</a>
          <button data-action="edit-workflow" data-workflow-id="{{ item.id }}" class="px-4 py-2 rounded-lg border border-blue-400/40 text-blue-200 hover:border-blue-400 hover:text-blue-100 transition text-sm">Editar</button>
          <button data-action="delete-workflow" data-workflow-id="{{ item.id }}" class="px-4 py-2 rounded-lg border border-red-400/40 text-red-200 hover:border-red-400 hover:text-red-100 transition text-sm">Excluir</button>
        </div>
      </article>
      {% else %}
      <p class="text-sm opacity-70">Nenhum workflow desta empresa ainda.</p>
      {% endfor %}
    </div>
  </div>

</section>

<!-- Modais de empresa (reaproveitados parcialmente da lista, mas simples aqui) -->
<div id="editEmpresaModal" class="modal-backdrop fixed inset-0 bg-black/60 hidden z-50">
  <div class="w-full h-full flex items-center justify-center p-6">
    <div class="modal-content max-w-lg w-full {{ theme.modal }} rounded-2xl shadow-2xl border border-white/10">
      <div class="px-6 py-4 border-b border-white/10">
        <h2 class="text-lg font-semibold">Editar empresa</h2>
      </div>
      <div class="px-6 py-6 grid gap-4">
        <label class="grid gap-2">
          <span class="text-sm font-medium opacity-80">Nome da empresa</span>
          <input type="text" id="editEmpresaNome" required maxlength="255" class="rounded-lg border border-white/20 bg-transparent px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500/60" value="{{ empresa.nome }}" />
        </label>
        <label class="grid gap-2">
          <span class="text-sm font-medium opacity-80">Descrição</span>
          <textarea id="editEmpresaDescricao" rows="3" class="rounded-lg border border-white/20 bg-transparent px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500/60">{{ empresa.descricao or '' }}</textarea>
        </label>
        <p id="editEmpresaFeedback" class="text-sm hidden"></p>
      </div>
      <div class="px-6 py-4 border-t border-white/10 flex gap-3 justify-end">
        <button data-action="cancel-edit" class="px-4 py-2 rounded-lg border border-white/20 hover:border-white/40 transition text-sm">Cancelar</button>
        <button data-action="confirm-edit" class="px-4 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 text-white font-medium transition text-sm">Salvar alterações</button>
      </div>
    </div>
  </div>
</div>

<div id="deleteEmpresaModal" class="modal-backdrop fixed inset-0 bg-black/60 hidden z-50">
  <div class="w-full h-full flex items-center justify-center p-6">
    <div class="modal-content max-w-md w-full {{ theme.modal }} rounded-2xl shadow-2xl border border-white/10">
      <div class="px-6 py-4 border-b border-white/10">
        <h2 class="text-lg font-semibold text-red-400">Confirmar exclusão</h2>
      </div>
      <div class="px-6 py-6">
        <p class="text-sm opacity-90 mb-2">Deseja realmente excluir a empresa:</p>
        <p class="font-semibold text-lg mb-4">{{ empresa.nome }}</p>
        <p class="text-sm opacity-70">Esta ação é permanente e não poderá ser desfeita.</p>
      </div>
      <div class="px-6 py-4 border-t border-white/10 flex gap-3 justify-end">
        <button data-action="cancel-delete" class="px-4 py-2 rounded-lg border border-white/20 hover:border-white/40 transition text-sm">Cancelar</button>
        <button data-action="confirm-delete" class="px-4 py-2 rounded-lg bg-red-500 hover:bg-red-600 text-white font-medium transition text-sm">Excluir empresa</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal criar workflow da empresa -->
<div id="createWorkflowModal" class="modal-backdrop fixed inset-0 bg-black/60 hidden z-50">
  <div class="w-full h-full flex items-center justify-center p-6">
    <div class="modal-content max-w-lg w-full {{ theme.modal }} rounded-2xl shadow-2xl border border-white/10">
      <div class="px-6 py-4 border-b border-white/10">
        <h2 class="text-lg font-semibold">Criar novo workflow</h2>
      </div>
      <div class="px-6 py-6">
        <form class="grid gap-4">
          <label class="grid gap-2">
            <span class="text-sm font-medium opacity-80">Nome do workflow</span>
            <input type="text" id="createWorkflowNome" required maxlength="255" class="rounded-lg border border-white/20 bg-transparent px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500/60" placeholder="Ex.: Balancete Mensal" />
          </label>
          <label class="grid gap-2">
            <span class="text-sm font-medium opacity-80">Descrição</span>
            <textarea id="createWorkflowDescricao" rows="3" class="rounded-lg border border-white/20 bg-transparent px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500/60" placeholder="Objetivo e contexto do workflow"></textarea>
          </label>
          <label class="grid gap-2">
            <span class="text-sm font-medium opacity-80">Tipo</span>
            <select id="createWorkflowTipo" required class="rounded-lg border border-white/20 bg-transparent px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500/60">
              <option value="">Selecione...</option>
              <option value="balancete">Balancete</option>
              <option value="analise_jp">Análise JP</option>
            </select>
          </label>
          <p id="createWorkflowFeedback" class="text-sm hidden"></p>
        </form>
      </div>
      <div class="px-6 py-4 border-t border-white/10 flex gap-3 justify-end">
        <button data-action="cancel-create-wf" class="px-4 py-2 rounded-lg border border-white/20 hover:border-white/40 transition text-sm">Cancelar</button>
        <button data-action="confirm-create-wf" class="px-4 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 text-white font-medium transition text-sm">Criar workflow</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  window.__EMPRESA__ = {{ empresa|tojson }};
  window.__WORKFLOWS__ = {{ workflows|tojson }};
  window.__EMPRESA_ID__ = {{ empresa.id }};
  // Substitui somente a visualização da URL por um slug legível
  (function() {
    try {
      var empresa = window.__EMPRESA__ || {};
      var name = (empresa.nome || '').toString();
      if (!name) return;
      var slug = name
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
        .toLowerCase().replace(/[^a-z0-9]+/g, '-')
        .replace(/(^-|-$)/g, '') || 'empresa';
      var current = window.location.pathname;
      // Se estamos em /empresas/<id>, substitui por /empresas/<slug>
      if (/^\/empresas\/(\d+)(\/)?$/.test(current)) {
        var newPath = '/empresas/' + slug;
        if (current !== newPath) {
          window.history.replaceState({}, document.title, newPath + window.location.search + window.location.hash);
        }
      }
    } catch (e) {
      console.warn('Não foi possível ajustar a URL amigável da empresa:', e);
    }
  })();
</script>
<script src="{{ url_for('static', filename='js/empresa_detail.js') }}"></script>
{% endblock %}

